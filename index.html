<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Kamera-Test (fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: dark light; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #0b0e13; color: #e8eef7; display: grid; place-items: center; min-height: 100dvh;
    }
    .wrap { width: min(900px, 96vw); padding: 16px; }
    h1 { font-size: 1.2rem; margin: 0 0 12px; font-weight: 600; }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    button {
      padding: 10px 14px; border: 0; border-radius: 10px; background: #2563eb; color: #fff;
      font-weight: 600; cursor: pointer;
    }
    button.secondary { background: #334155; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel {
      background: #121826; border: 1px solid #1f2937; border-radius: 12px; padding: 12px;
    }
    video {
      width: 100%; max-height: 70dvh; background: #000; border-radius: 10px; display: block;
    }
    .status { margin-top: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .95rem; }
    .ok { color: #34d399; } .warn { color: #ffb020; } .err { color: #ff6b6b; }
    .note { opacity: .85; font-size: .9rem; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∑ Kamera</h1>

    <div class="bar">
      <button id="start">Kamera starten</button>
      <button id="stop" class="secondary" disabled>Stop</button>
    </div>

    <div class="panel">
      <!-- Wichtig: playsinline + muted + autoplay -->
      <video id="video" playsinline muted autoplay></video>
      <div id="status" class="status">Bereit.</div>
      <div id="hint" class="note"></div>
    </div>

    <div class="note">
      Hinweis: Kamera-Zugriff funktioniert nur √ºber <b>https://</b> oder <b>http://localhost</b>.
    </div>
  </div>

  <script>
    // --- Elemente ---
    const btnStart = document.getElementById('start');
    const btnStop  = document.getElementById('stop');
    const video    = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const hintEl   = document.getElementById('hint');

    let stream = null;

    function setStatus(text, cls = '') {
      statusEl.className = 'status ' + cls;
      statusEl.textContent = text;
    }
    function setHint(text, cls = '') {
      hintEl.className = 'note ' + cls;
      hintEl.textContent = text;
    }
    function isSecure() {
      return location.protocol === 'https:' || location.hostname === 'localhost';
    }

    async function startCamera() {
      setHint('', '');
      if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia) {
        setStatus('getUserMedia wird von diesem Browser nicht unterst√ºtzt.', 'err');
        return;
      }
      if (!isSecure()) {
        setHint('Unsicherer Kontext erkannt. Bitte √ºber HTTPS oder localhost √∂ffnen ‚Äì sonst kann die Kamera blockiert werden.', 'warn');
      }

      // Falls noch was l√§uft: aufr√§umen
      stopCamera();

      // Mobile‚Äëfreundlich (Autoplay darf sonst blocken)
      video.setAttribute('playsinline', '');
      video.muted = true;

      const preferred = {
        audio: false,
        video: {
          facingMode: { ideal: 'environment' }, // R√ºckkamera bevorzugt
          width:  { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };

      setStatus('Kamera wird gestartet ‚Ä¶');
      try {
        stream = await navigator.mediaDevices.getUserMedia(preferred);
      } catch (e1) {
        // Fallback ohne harte Anforderungen
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          setHint('Fallback ohne spezielle Kamera-Constraints aktiv.', 'warn');
        } catch (e2) {
          handleError(e2);
          return;
        }
      }

      // Stream ans Video binden und starten
      video.srcObject = stream;
      try {
        await video.play(); // kann auf Mobile eine User‚ÄëInteraktion erfordern
      } catch (e) {
        setHint('Autoplay wurde blockiert. Tippe erneut auf ‚ÄûKamera starten‚Äú.', 'warn');
      }

      // Metadaten ‚Üí Aufl√∂sung anzeigen
      if (video.readyState >= 1) {
        setStatus(`L√§uft: ${video.videoWidth}√ó${video.videoHeight}`, 'ok');
      }
      video.addEventListener('loadedmetadata', () => {
        setStatus(`L√§uft: ${video.videoWidth}√ó${video.videoHeight}`, 'ok');
      }, { once: true });

      btnStart.disabled = true;
      btnStop.disabled  = false;
    }

    function stopCamera() {
      try {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      } catch {}
      video.srcObject = null;
      setStatus('Gestoppt.');
      btnStart.disabled = false;
      btnStop.disabled  = true;
    }

    function handleError(err) {
      console.error(err);
      const map = {
        NotAllowedError:   'Zugriff verweigert. Pr√ºfe die Seitenberechtigungen (Kamera zulassen).',
        NotFoundError:     'Keine Kamera gefunden.',
        OverconstrainedError: 'Angeforderte Aufl√∂sung wird nicht unterst√ºtzt. Bitte erneut versuchen.',
        SecurityError:     'Unsicherer Kontext ‚Äì verwende HTTPS oder localhost.',
        AbortError:        'System hat den Zugriff abgebrochen. Bitte erneut versuchen.'
      };
      const msg = map[err.name] || (err.message || String(err));
      setStatus('Fehler', 'err');
      setHint(msg, 'err');
      btnStart.disabled = false;
      btnStop.disabled  = true;
    }

    // Buttons
    btnStart.addEventListener('click', startCamera);
    btnStop.addEventListener('click', stopCamera);

    // Aufr√§umen, wenn Tab/Seite verlassen wird (Kamera freigeben)
    window.addEventListener('pagehide', stopCamera);
    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
